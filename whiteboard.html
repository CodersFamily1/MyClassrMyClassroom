<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Online Classroom ‚Äî Whiteboard</title>
<style>
  :root{
    --brand:#4f46e5;
    --brand-dark:#4338ca;
    --bg:#f8faff;
    --card:#ffffff;
    --text:#2c3e50;
    --muted:#667085;
    --danger:#e74c3c;
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:var(--bg);font-family:"Segoe UI", Tahoma, sans-serif;color:var(--text);
    display:flex;flex-direction:column;min-height:100vh;
  }
  header{
    position:sticky;top:0;background:var(--card);z-index:20;border-bottom:1px solid #eef2f7;
  }
  .bar{
    max-width:1200px;margin:0 auto;display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    padding:10px 16px;
  }
  .title{font-weight:700;letter-spacing:.3px;margin-right:auto}
  button,.btn{
    background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;
    transition:.2s;font-weight:600
  }
  button:hover{background:var(--brand-dark)}
  .btn-outline{background:#fff;color:var(--brand);border:1px solid #dcdfe6}
  .btn-outline:hover{background:#f4f5ff}
  .btn-danger{background:var(--danger)}
  .btn-danger:hover{background:#c0392b}
  .chip{padding:8px 10px;border-radius:10px;background:#f2f3ff;border:1px solid #e7e9ff;color:#3b37b3;font-weight:600}
  main{max-width:1200px;margin:14px auto;display:grid;grid-template-columns:1fr 300px;gap:16px;padding:0 16px; width:100%}
  .panel{background:var(--card);border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:12px}
  #board{width:100%;height:auto;border:1px solid #dcdfe6;border-radius:12px;background:#fff;touch-action:none;display:block}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .col{display:flex;flex-direction:column;gap:6px}
  label{font-size:12px;color:var(--muted)}
  input[type="range"]{width:160px}
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .divider{height:1px;background:#eef2f7;margin:8px 0}
  #toast{
    position:fixed;left:50%;top:14px;transform:translateX(-50%);
    background:#111827;color:#fff;padding:10px 16px;border-radius:10px;opacity:0;pointer-events:none;
    transition:.25s;z-index:40;font-weight:600;box-shadow:0 8px 24px rgba(0,0,0,.2)
  }
  #toast.show{opacity:1}
  #participants{list-style:none;padding:0;margin:0;display:flex;flex-wrap:wrap;gap:8px}
  #participants li{background:#f3f4ff;border:1px solid #e7e9ff;color:#3730a3;padding:6px 10px;border-radius:999px;font-weight:600}
  .side-title{font-weight:700;margin-bottom:8px}
  .pill{padding:6px 10px;border:1px solid #e9eef5;border-radius:8px;background:#fafcff}
  .note{font-size:12px;color:#6b7280}
  @media (max-width:1024px){ main{grid-template-columns:1fr} }
</style>
</head>
<body>

<header>
  <div class="bar">
    <div class="title">üßë‚Äçüè´ Online Classroom ‚Äî Whiteboard</div>
    <button id="save-btn" title="Save board as PNG">Save PNG</button>
    <button id="clear-btn" class="btn-outline" title="Clear the board">Clear</button>
    <span class="chip" id="room-chip">Room: ‚Äî</span>
    <button id="leave-btn" class="btn-danger">Leave Room</button>
  </div>
</header>

<main>
  <section class="panel">
    <!-- Top controls -->
    <div class="controls" style="margin-bottom:10px">
      <div class="col">
        <label>Color</label>
        <input type="color" id="color-picker" value="#111111">
      </div>

      <div class="col">
        <label>Brush Size <span id="size-val" class="pill">3</span></label>
        <div class="row">
          <button id="size-dec" class="btn-outline" title="Smaller">‚àí</button>
          <input type="range" id="size-slider" min="1" max="30" value="3">
          <button id="size-inc" class="btn-outline" title="Bigger">+</button>
        </div>
      </div>

      <div class="col">
        <label>Mode</label>
        <div class="row">
          <button id="pen-btn" class="btn">Pen</button>
          <button id="eraser-btn" class="btn-outline">Eraser</button>
          <button id="text-btn" class="btn-outline">Text</button>
        </div>
      </div>

      <div class="col">
        <label>Canvas Width <span id="w-val" class="pill">800</span></label>
        <div class="row">
          <input type="range" id="width-slider" min="500" max="1400" value="800">
        </div>
      </div>

      <div class="col">
        <label>Canvas Height <span id="h-val" class="pill">500</span></label>
        <div class="row">
          <input type="range" id="height-slider" min="300" max="900" value="500">
        </div>
      </div>
    </div>

    <!-- Canvas -->
    <canvas id="board" width="800" height="500"></canvas>

    <!-- Footer info -->
    <div class="row" style="justify-content:space-between;margin-top:8px">
      <div class="note">Tip: Text ‡¶Æ‡ßã‡¶°‡ßá ‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá ‡¶ü‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ü‡¶æ‡¶á‡¶™ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡•§</div>
      <div class="note">Realtime sync ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‚úÖ</div>
    </div>
  </section>

  <aside class="panel">
    <div class="side-title">Participants</div>
    <ul id="participants"></ul>
    <div class="divider"></div>

    <div class="side-title">Room Info</div>
    <div class="pill" id="user-pill">You: ‚Äî</div>
    <div class="row" style="margin-top:8px">
      <div class="pill" id="timer-pill">00:00:00</div>
    </div>
  </aside>
</main>

<div id="toast">Board cleared</div>

<script type="module">
/** ---------- Firebase ---------- **/
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc,
  getDocs, serverTimestamp, setDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA_cKg4aCmS2EUJhE8Baq-wQK26Smu7pxY",
  authDomain: "myclassroom-67acf.firebaseapp.com",
  projectId: "myclassroom-67acf",
  storageBucket: "myclassroom-67acf.appspot.com",
  messagingSenderId: "319313107001",
  appId: "1:319313107001:web:52e7f5ca05e8721dded5e8"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/** ---------- Params & Guards ---------- **/
const params = new URLSearchParams(location.search);
const roomId = params.get("roomId");
const username = params.get("username");
if(!roomId || !username){
  alert("Invalid room. Redirecting to login.");
  location.href = "login.html";
}
document.getElementById("room-chip").textContent = `Room: ${roomId.slice(0,6)}‚Ä¶`;

/** ---------- Presence (participants) ---------- **/
let meDocRef = null;
onAuthStateChanged(auth, async (user) => {
  if(!user){
    alert("Login required"); location.href = "login.html"; return;
  }
  document.getElementById("user-pill").textContent = `You: ${username}`;
  // create/update my presence doc
  meDocRef = doc(collection(db, "rooms", roomId, "participants"), user.uid);
  await setDoc(meDocRef, {
    uid: user.uid,
    name: username,
    joinedAt: serverTimestamp()
  }, { merge: true });

  // remove presence on leave/close
  window.addEventListener("beforeunload", async () => {
    try{ await deleteDoc(meDocRef); }catch(_){}
  });
});

// live participants list
onSnapshot(collection(db, "rooms", roomId, "participants"), (snap) => {
  const ul = document.getElementById("participants");
  ul.innerHTML = "";
  snap.forEach(d => {
    const li = document.createElement("li");
    li.textContent = d.data().name || "User";
    ul.appendChild(li);
  });
});

/** ---------- Canvas & Drawing ---------- **/
const canvas = document.getElementById("board");
const ctx = canvas.getContext("2d");
let mode = "pen"; // pen | eraser | text
let color = document.getElementById("color-picker").value;
let size = parseInt(document.getElementById("size-slider").value, 10);
let drawing = false;
let stroke = []; // buffered points to save once per stroke
const strokesCache = []; // for re-render on resize
const textsCache = [];

const sizeVal = document.getElementById("size-val");
sizeVal.textContent = size;

function setMode(m){
  mode = m;
  document.getElementById("pen-btn").className = m==="pen" ? "btn" : "btn-outline";
  document.getElementById("eraser-btn").className = m==="eraser" ? "btn" : "btn-outline";
  document.getElementById("text-btn").className = m==="text" ? "btn" : "btn-outline";
}
setMode("pen");

// Controls
document.getElementById("color-picker").addEventListener("change", e => color = e.target.value);
document.getElementById("size-slider").addEventListener("input", e => {
  size = parseInt(e.target.value, 10);
  sizeVal.textContent = size;
});
document.getElementById("size-dec").addEventListener("click", () => {
  size = Math.max(1, size-1);
  document.getElementById("size-slider").value = size;
  sizeVal.textContent = size;
});
document.getElementById("size-inc").addEventListener("click", () => {
  size = Math.min(30, size+1);
  document.getElementById("size-slider").value = size;
  sizeVal.textContent = size;
});
document.getElementById("pen-btn").addEventListener("click", () => setMode("pen"));
document.getElementById("eraser-btn").addEventListener("click", () => setMode("eraser"));
document.getElementById("text-btn").addEventListener("click", () => setMode("text"));

// Helpers
function getPos(evt){
  const rect = canvas.getBoundingClientRect();
  return { x: (evt.clientX - rect.left), y: (evt.clientY - rect.top) };
}
function drawSegment(a,b,c,w){
  ctx.strokeStyle = c;
  ctx.lineWidth = w;
  ctx.lineCap = "round";
  ctx.beginPath();
  ctx.moveTo(a.x, a.y);
  ctx.lineTo(b.x, b.y);
  ctx.stroke();
}
function redrawAll(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(const s of strokesCache){
    const pts = s.stroke;
    for(let i=1;i<pts.length;i++){
      drawSegment(pts[i-1], pts[i], s.color, s.width);
    }
  }
  for(const t of textsCache){
    ctx.fillStyle = t.color;
    ctx.font = `${t.size || 20}px Arial`;
    ctx.fillText(t.text, t.x, t.y);
  }
}

// Mouse/Touch drawing
function startDraw(p){
  if(mode==="text"){
    const text = prompt("Enter text:");
    if(!text) return;
    const record = { x: p.x, y: p.y, text, color, size: 20, ts: Date.now() };
    textsCache.push(record);
    ctx.fillStyle = color; ctx.font = "20px Arial"; ctx.fillText(text, p.x, p.y);
    addDoc(collection(db, "rooms", roomId, "texts"), record);
    return;
  }
  drawing = true;
  stroke = [{x:p.x,y:p.y}];
}
function moveDraw(p){
  if(!drawing) return;
  const last = stroke[stroke.length-1];
  const drawColor = (mode==="eraser") ? "#ffffff" : color;
  const drawWidth = (mode==="eraser") ? Math.max(12, size*3) : size;
  drawSegment(last, p, drawColor, drawWidth);
  stroke.push({x:p.x,y:p.y});
}
async function endDraw(){
  if(!drawing) return;
  drawing = false;
  if(stroke.length>1){
    const docData = { stroke, color: (mode==="eraser")?"#ffffff":color, width: (mode==="eraser")?Math.max(12, size*3):size, ts: Date.now() };
    strokesCache.push(docData);
    try{ await addDoc(collection(db,"rooms",roomId,"drawings"), docData); }catch(e){ console.error(e); }
  }
  stroke = [];
}

// Bind events
canvas.addEventListener("mousedown", e => startDraw(getPos(e)));
canvas.addEventListener("mousemove", e => moveDraw(getPos(e)));
window.addEventListener("mouseup", endDraw);
canvas.addEventListener("touchstart", e => { e.preventDefault(); startDraw(getPos(e.touches[0])); }, {passive:false});
canvas.addEventListener("touchmove", e => { e.preventDefault(); moveDraw(getPos(e.touches[0])); }, {passive:false});
canvas.addEventListener("touchend", e => { e.preventDefault(); endDraw(); }, {passive:false});

// Live listeners (drawings)
onSnapshot(collection(db,"rooms",roomId,"drawings"), (snapshot) => {
  snapshot.docChanges().forEach(ch => {
    if(ch.type === "added"){
      const d = ch.doc.data();
      strokesCache.push(d);
      const pts = d.stroke;
      for(let i=1;i<pts.length;i++){
        drawSegment(pts[i-1], pts[i], d.color, d.width);
      }
    } else if(ch.type === "removed"){
      // full redraw from cache (after local clear we also clear cache)
      redrawAll();
    }
  });
});
// Live listeners (texts)
onSnapshot(collection(db,"rooms",roomId,"texts"), (snapshot) => {
  snapshot.docChanges().forEach(ch => {
    if(ch.type === "added"){
      const t = ch.doc.data();
      textsCache.push(t);
      ctx.fillStyle = t.color;
      ctx.font = `${t.size || 20}px Arial`;
      ctx.fillText(t.text, t.x, t.y);
    } else if(ch.type === "removed"){
      redrawAll();
    }
  });
});

/** ---------- Canvas Resize (both width/height) ---------- **/
const wSlider = document.getElementById("width-slider");
const hSlider = document.getElementById("height-slider");
const wVal = document.getElementById("w-val");
const hVal = document.getElementById("h-val");

function resizeCanvas(w, h){
  // Keep current image as data, then resize, then redraw caches for pixel-perfect
  const img = ctx.getImageData(0,0,canvas.width,canvas.height);
  canvas.width = w; canvas.height = h;
  ctx.putImageData(img,0,0);
  // Full redraw from logical caches (keeps consistency)
  redrawAll();
}
wSlider.addEventListener("input", e => { const w = parseInt(e.target.value,10); wVal.textContent = w; resizeCanvas(w, canvas.height); });
hSlider.addEventListener("input", e => { const h = parseInt(e.target.value,10); hVal.textContent = h; resizeCanvas(canvas.width, h); });

/** ---------- Clear (one click = one clear) ---------- **/
const toast = document.getElementById("toast");
function showToast(msg="Board cleared"){
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"), 1600);
}
document.getElementById("clear-btn").addEventListener("click", async () => {
  if(!confirm("Clear the whole board for everyone?")) return;
  // delete drawings
  const drawingsSnap = await getDocs(collection(db,"rooms",roomId,"drawings"));
  const textsSnap = await getDocs(collection(db,"rooms",roomId,"texts"));
  const promises = [];
  drawingsSnap.forEach(d => promises.push(deleteDoc(doc(db,"rooms",roomId,"drawings", d.id))));
  textsSnap.forEach(d => promises.push(deleteDoc(doc(db,"rooms",roomId,"texts", d.id))));
  await Promise.all(promises);
  // local clear & caches reset
  strokesCache.length = 0;
  textsCache.length = 0;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  showToast("Board cleared for all");
});

/** ---------- Save as PNG ---------- **/
document.getElementById("save-btn").addEventListener("click", () => {
  const link = document.createElement("a");
  link.download = `whiteboard-${roomId}.png`;
  link.href = canvas.toDataURL("image/png");
  link.click();
});

/** ---------- Timer ---------- **/
const timer = document.getElementById("timer-pill");
const started = Date.now();
setInterval(() => {
  const ms = Date.now() - started;
  const h = Math.floor(ms/3600000);
  const m = Math.floor((ms%3600000)/60000);
  const s = Math.floor((ms%60000)/1000);
  timer.textContent = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}, 1000);

/** ---------- Leave Room ---------- **/
document.getElementById("leave-btn").addEventListener("click", async () => {
  try{
    if(meDocRef) await deleteDoc(meDocRef);
    await signOut(auth);
  }catch(_){}
  location.href = "login.html";
});
</script>
</body>
</html>